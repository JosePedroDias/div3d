(function(){var rad90=Math.PI/2;var rad180=Math.PI;var boxStuff=[[[2,1],[0,-1,0],0],[[2,1],[0,1,0],0],[[0,2],[-1,0,0],0],[[0,2],[1,0,0],0],[[0,1],[0,0,0],1],[[0,1],[0,1,0],1]];var DQuad=function(el,mtx){if(!mtx){mtx=mat4.create(1);mat4.identity(mtx)}this._el=el;this._mtx=mtx;this._trans={}};DQuad.prototype={translate:function(pos){this._trans.t=pos;DIV3D._needUpdate[this._id]=true},rotate:function(angle,axis){this._trans.r=[angle,axis];DIV3D._needUpdate[this._id]=true},scale:function(s){this._trans.s=s;DIV3D._needUpdate[this._id]=true},resize:function(dims,center){this._size=dims;var cir=[false,false];var i,d,ci;if(!center){center=[.5,.5];cir=[true,true]}else{for(i=0;i<2;++i){ci=center[i];if(ci<=1){cir[i]=true}}}for(i=0;i<2;++i){ci=center[i];d=dims[i];center[i]=Math.round(-d+ci*(cir[i]?d:1))}var s=this._el.style;s.width=dims[0]+"px";s.height=dims[1]+"px";s.marginLeft=center[0]+"px";s.marginTop=center[1]+"px"},addClass:function(clsName){if(clsName.indexOf(" ")===-1){this._el.classList.add(clsName)}else{var classes=clsName.split(" ");for(var i=0,f=classes.length;i<f;++i){this._el.classList.add(classes[i])}}},removeClass:function(clsName){if(clsName.indexOf(" ")===-1){this._el.classList.remove(clsName)}else{var classes=clsName.split(" ");for(var i=0,f=classes.length;i<f;++i){this._el.classList.remove(classes[i])}}},opacity:function(n){this._el.style.opacity=n},color:function(c){this._el.style.backgroundColor=c},markup:function(html){this._el.innerHTML=html},centerText:function(){var s=this._el.style;s.textAlign="center";s.lineHeight=this._size[1]+"px"},_update:function(){var m=["matrix3d(",mat4.str(this._mtx),")"].join("");this._el.style.WebkitTransform=m;this._el.style.MozTransform=m;this._el.style.oTransform=m;this._el.style.transform=m},_clear:function(){mat4.identity(this._mtx)},_t:function(vec){mat4.translate(this._mtx,this._mtx,vec)},_r:function(angle,axis){mat4.rotate(this._mtx,this._mtx,angle,axis)},_s:function(s){if(typeof s==="number"){s=[s,s,s]}mat4.scale(this._mtx,this._mtx,s)},_mtxClone:function(){return mat4.clone(this._mtx)},_billboard:function(pos){this._t(pos);mat4.copy(this._mtx,DIV3D._camera._mtx);mat4.transpose(this._mtx,this._mtx);var m=this._mtx;m[12]=pos[0];m[13]=pos[1];m[14]=pos[2];m[3]=0;m[7]=0;m[11]=0;m[15]=1;this._update()},_billboardAxisAligned:function(pos,axisNum){var camPos=this._camera._from;var look=vec3.create();vec3.sub(look,camPos,pos);look[axisNum]=0;vec3.normalize(look,look);var up=vec3.create();up[axisNum]=1;var right=vec3.create();vec3.cross(right,up,look);var m=this._mtx;m[0]=right[0];m[1]=right[1];m[2]=right[2];m[3]=0;m[4]=up[0];m[5]=up[1];m[6]=up[2];m[7]=0;m[8]=look[0];m[9]=look[1];m[10]=look[2];m[11]=0;m[12]=pos[0];m[13]=pos[1];m[14]=pos[2];m[15]=1;this._update()}};DIV3D={_containerDims:[0,0],_lastId:1,_startT:undefined,_objects:{},_needUpdate:{},_lookAtDependent:{},_animationFn:[],init:function(ctnEl){this._startT=(new Date).valueOf();if(!ctnEl){ctnEl=document.createElement("div");ctnEl.className="container";ctnEl.id="d"+this._lastId++;document.body.appendChild(ctnEl)}this._finishDiv(ctnEl,ctnEl.id);this._root0=this._createDiv("root0",ctnEl.id);this._camera=this._createDiv("camera","root0");this._root=this._createDiv("root","camera");this._camera._from=[0,-100,0];this._onResize();window.addEventListener("resize",function(){DIV3D._onResize()});var render=function(t){var dt=DIV3D.time(t);DIV3D._updateDOM();DIV3D._applyAnimations(t,dt);requestAnimationFrame(render)};render()},time:function(t){if(!t){t=(new Date).valueOf()-this._startT}this._dt=t-(this._t||1/60);this._t=t;return this._dt},get:function(id){return this._objects[id]},setCamera:function(o){var from=o.from||this._camera._from;var to=o.to||this._camera._to||[0,0,0];var up=o.up||this._camera._up||[0,1,0];mat4.lookAt(this._camera._mtx,from,to,up);this._camera._update();this._camera._from=from;this._camera._to=to;this._camera._up=up;for(var id in this._lookAtDependent){o=this._objects[id];o._billboard(o._position)}},setCubeMap:function(opts){this._cubeMap=this.createBox({invert:true,dimensions:[opts.size,opts.size,opts.size],forEach:function(f,i){var s=f._el.style;s.backgroundImage=["url(",opts.image.replace("$",i),")"].join("");s.backgroundSize="100% 100%";f.markup(i);f.opacity(.5);s.color="#FFF";s.fontSize=~~(opts.size*.75)+"px";s.lineHeight=opts.size+"px";s.textAlign="center"}})},onFrame:function(fn){this._animationFn.push(fn)},createGroup:function(id,parent){return this._createDiv(id,parent)},createRect:function(opts){var o=this._createDiv(opts.id,opts.parent);if("size"in opts){o.resize(opts.size)}if("classes"in opts){o.addClass(opts.classes)}if("markup"in opts){o.markup(opts.markup)}if("color"in opts){o.color(opts.color)}return o},createBillboard:function(opts){var o=this.createRect(opts);o.translate(opts.position);this._lookAtDependent[o._id]=true;o._billboard(o._position)},createBox:function(opts){var dims,f,g=this._createDiv(opts.id,opts.parent);var a,b,bs;g.faces=new Array(6);for(var i=0;i<6;++i){if(opts.skips&&opts.skips.indexOf(i)!==-1){continue}f=this._createDiv(undefined,g._el);bs=boxStuff[i];a=bs[0];b=opts.dimensions;dims=[b[a[0]],b[a[1]]];f.resize(dims);a=[0,0,0];b=~~(i/2);a[b]=opts.dimensions[b]/(i%2?-2:2)*(b===0?-1:1);f._t(a);if(i<6){f._r(rad90*(i===5?2:1),bs[1])}if(opts.invert){if(i<2){f._r(rad180,[0,1,0])}else if(i>3){f._r(rad180,[1,0,0]);f._r(rad180,[0,0,1])}else{f._r(rad180,[1,0,0])}}if(opts.forEach){opts.forEach(f,i,dims)}f._update();g.faces[i]=f}return g},_createDiv:function(id,parent){var el=document.createElement("div");el.className="node";if(!id){id="d"+this._lastId++}el.id=id;if(!parent){parent="root"}if(typeof parent==="string"){parent=this.get(parent)}if(!parent.parentNode){parent=parent._el}parent.appendChild(el);return this._finishDiv(el,id)},_finishDiv:function(el,id){var o=new DQuad(el);o._id=id;this._objects[id]=o;return o},_updateDOM:function(){var o,id,p;for(id in this._needUpdate){o=this._objects[id];o._clear();p=o._trans.s;if(p){o._s(p)}p=o._trans.r;if(p){o._r(p[0],p[1])}p=o._trans.t;if(p){o._t(p)}o._update()}this._needUpdate={}},_applyAnimations:function(t,dt){var i,f,fn;for(i=0,f=this._animationFn.length;i<f;++i){fn=this._animationFn[i];fn(t,dt)}},_onResize:function(){var W=window.innerWidth;var H=window.innerHeight;this._containerDims=[W,H];var o=this._root0;o._clear();o._t([W/2,H/2,0]);o._update()}}})();